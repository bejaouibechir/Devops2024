#  Environment, Param√®tres et Variables

Ce tutoriel explique l'utilisation des **variables d'environnement (`environment`)**, des **param√®tres utilisateur (`params`)**, et des **variables locales** dans un pipeline Jenkins. Il met en √©vidence leurs diff√©rences et comment les utiliser intelligemment.

## 1. D√©finition des Variables d'Environnement (`environment`)
Les variables d√©finies dans `environment` sont accessibles **dans tout le pipeline**, y compris dans les √©tapes `script` et `sh`. Elles sont id√©ales pour **stocker des valeurs globales** qui ne changent pas durant l'ex√©cution.

```groovy
pipeline {
    agent any
    environment {
        GLOBAL_VAR = 'Production'
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}" // D√©finition avec le num√©ro du build
    }
    stages {
        stage('Afficher les Variables') {
            steps {
                script {
                    echo "Global: ${env.GLOBAL_VAR}"
                    echo "Version du build: ${env.BUILD_VERSION}"
                }
            }
        }
    }
}

```
- `GLOBAL_VAR` est une variable globale d√©finie pour tout le pipeline.
- `BUILD_VERSION` utilise `BUILD_NUMBER` pour cr√©er une version unique √† chaque ex√©cution.

**Pourquoi BUILD_NUMBER ?**
- Il est automatiquement d√©fini par Jenkins √† chaque ex√©cution d‚Äôun pipeline.
- Il est accessible via env.BUILD_NUMBER.
- Il permet d‚Äôajouter un identifiant unique aux builds.

## 2. D√©finition des Param√®tres Utilisateur (`params`)
Les **param√®tres** permettent √† l'utilisateur de passer des valeurs **au moment de l'ex√©cution** du pipeline. Contrairement √† `environment`, ils ne sont pas d√©finis √† l'avance mais sont entr√©s par l'utilisateur.

```groovy
    pipeline {
    agent any

    environment {
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}"
    }

    parameters {
        string(name: 'DEPLOY_ENV', defaultValue: 'staging', description: 'Environnement de d√©ploiement')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Ex√©cuter les tests ?')
    }

    stages {
        stage('Afficher les Variables') {
            steps {
                script {
                    echo "Version du build: ${env.BUILD_VERSION}"
                    echo "Environnement de d√©ploiement: ${params.DEPLOY_ENV}"
                    echo "Ex√©cuter les tests ?: ${params.RUN_TESTS}"
                }
            }
        }
    }
}
```
- `DEPLOY_ENV` est un param√®tre **modifiable par l'utilisateur**.
- `RUN_TESTS` est un **bool√©en** utilis√© pour activer/d√©sactiver l'ex√©cution des tests.

## 3. Affichage des Variables
Ici, on combine `environment`, `params`, et une variable **locale** d√©finie √† l'int√©rieur du script.

```groovy
    pipeline {
    agent any

    environment {
        GLOBAL_VAR = 'Production'
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}"
    }

    parameters {
        string(name: 'DEPLOY_ENV', defaultValue: 'staging', description: 'Environnement de d√©ploiement')
    }

    stages {
        stage('Affichage des Variables') {
            steps {
                script {
                    def localVar = "Local-${env.BUILD_ID}"
                    
                    echo "Global: ${env.GLOBAL_VAR}"
                    echo "Build Version: ${env.BUILD_VERSION}"
                    echo "Param√®tre utilisateur: ${params.DEPLOY_ENV}"
                    echo "Variable locale: ${localVar}"
                }
            }
        }
    }
}
```
- `env.GLOBAL_VAR` et `env.BUILD_VERSION` viennent de `environment`.
- `params.DEPLOY_ENV` provient des param√®tres pass√©s par l'utilisateur.
- `localVar` est d√©finie **temporairement** dans ce `script`.

## 4. Utilisation Conditionnelle des Param√®tres
L‚Äô√©tape suivante **n‚Äôex√©cute les tests que si** `RUN_TESTS` est `true`.

```groovy
     pipeline {
            agent any
            
            parameters {
                string(name: 'DEPLOY_ENV', defaultValue: 'staging', description: 'Environnement de d√©ploiement')
            }

        stages {
        stage('Alternative staging') {
                when {
                    expression { params.DEPLOY_ENV == 'staging' }
                }
                steps {
                    echo 'Ex√©cution en mode staging'
                }
            }
            stage('Alternative production') {
                when {
                    expression { params.DEPLOY_ENV == 'production' }
                }
                steps {
                    echo 'Ex√©cution en mode production'
                }
            }
        }
}
```
- `when { expression { ... } }` emp√™che l'ex√©cution du stage si elle est `false`.

## 5. D√©ploiement en Fonction du Param√®tre ou de l‚ÄôEnvironnement
On utilise ici une combinaison de `params` et `environment` avec une **valeur par d√©faut**.

```groovy
        stage('D√©ploiement') {
            steps {
                script {
                    def targetEnv = params.DEPLOY_ENV ?: env.GLOBAL_VAR
                    echo "D√©ploiement sur ${targetEnv}"
                    sh "echo Deploying to ${targetEnv}"
                }
            }
        }
```
- `params.DEPLOY_ENV ?: env.GLOBAL_VAR` signifie : 
  - Si `DEPLOY_ENV` est d√©fini par l‚Äôutilisateur, on l‚Äôutilise.
  - Sinon, on utilise `GLOBAL_VAR` (d√©fini globalement).

## 6. Actions Post-Ex√©cution

```groovy
    post {
        always {
            echo 'Pipeline termin√©.'
        }
    }
}
```

## Diff√©rence entre `environment` et `params`
| Aspect | `environment` | `params` |
|--------|--------------|----------|
| D√©finition | Avant l‚Äôex√©cution | Lors du lancement |
| Modification | Impossible apr√®s le d√©but | Modifiable √† chaque ex√©cution |
| Utilisation | Valeurs constantes globales | Personnalisation utilisateur |
| Exemple | `env.GLOBAL_VAR` | `params.DEPLOY_ENV` |

## Conclusion
- **Utiliser `environment`** pour les valeurs **globales fixes**.
- **Utiliser `params`** pour les valeurs **modifiables par l'utilisateur**.
- **Combiner les deux intelligemment** avec `?:` pour une ex√©cution flexible et fiable. üöÄ
