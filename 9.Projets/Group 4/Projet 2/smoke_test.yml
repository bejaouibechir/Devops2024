---
- name: Tests de Smoke Blue/Green
  hosts: trumpito_servers
  become: yes
  
  vars:
    deploy_base: "/opt/trumpito"
    
  tasks:
    - name: ğŸ§ª DÃ©but des tests de smoke
      debug:
        msg: "ExÃ©cution des tests de smoke sur l'environnement {{ target_color }}"
    
    - name:  Test 1: VÃ©rifier l'existence du rÃ©pertoire
      stat:
        path: "{{ deploy_base }}/{{ target_color }}"
      register: env_dir
      failed_when: not env_dir.stat.exists
    
    - name:  Test 2: VÃ©rifier la prÃ©sence du binaire
      stat:
        path: "{{ deploy_base }}/{{ target_color }}/usr/bin/trumpito"
      register: binary
      failed_when: not binary.stat.exists or not binary.stat.executable
    
    - name:  Test 3: VÃ©rifier le fichier de version
      stat:
        path: "{{ deploy_base }}/{{ target_color }}/VERSION"
      register: version_file
      failed_when: not version_file.stat.exists
    
    - name:  Lire la version dÃ©ployÃ©e
      shell: "cat {{ deploy_base }}/{{ target_color }}/VERSION"
      register: version_content
      changed_when: false
    
    - name:  Test 4: ExÃ©cuter trumpito --version
      shell: "{{ deploy_base }}/{{ target_color }}/usr/bin/trumpito --version"
      register: trumpito_version
      changed_when: false
      failed_when: trumpito_version.rc != 0
    
    - name:  Test 5: VÃ©rifier la structure de la configuration
      stat:
        path: "/etc/trumpito-{{ target_color }}/trumpito.conf"
      register: config_file
      failed_when: not config_file.stat.exists
    
    - name:  Test 6: Test d'exÃ©cution dry-run
      shell: "{{ deploy_base }}/{{ target_color }}/usr/bin/trumpito --help"
      register: help_output
      changed_when: false
      failed_when: help_output.rc != 0
    
    - name:  Test 7: VÃ©rifier les permissions
      shell: |
        ls -l {{ deploy_base }}/{{ target_color }}/usr/bin/trumpito | grep -q "rwxr"
      changed_when: false
      failed_when: false
      register: perms_check
    
    - name:  Test 8: VÃ©rifier l'intÃ©gritÃ© des modules Python
      shell: |
        find {{ deploy_base }}/{{ target_color }}/usr/lib/python3/dist-packages/trumpito_* -name "*.py" | wc -l
      register: python_files
      changed_when: false
    
    - name:  VÃ©rifier le nombre de fichiers Python
      assert:
        that:
          - python_files.stdout|int > 0
        fail_msg: "Aucun fichier Python trouvÃ© dans les modules"
        success_msg: "{{ python_files.stdout }} fichiers Python dÃ©tectÃ©s"
    
    - name:  RÃ©sumÃ© des tests
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TESTS DE SMOKE RÃ‰USSIS
          
          Environnement testÃ©: {{ target_color }}
          
           Tests passÃ©s:
             RÃ©pertoire prÃ©sent
             Binaire exÃ©cutable
             Fichier de version OK
             Commande --version fonctionne
             Configuration prÃ©sente
             Commande --help fonctionne
             Permissions correctes
             Modules Python intÃ¨gres ({{ python_files.stdout }} fichiers)
          
          Version dÃ©ployÃ©e:
          {{ version_content.stdout }}
          
             L'environnement {{ target_color }} est prÃªt pour le trafic
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name:  Enregistrer le rÃ©sultat des tests
      copy:
        content: |
          Tests de smoke - {{ target_color }}
          Date: {{ ansible_date_time.iso8601 }}
          Statut: RÃ‰USSI   
          
          Tests exÃ©cutÃ©s:
          1. RÃ©pertoire prÃ©sent: OK
          2. Binaire exÃ©cutable: OK
          3. Fichier de version: OK
          4. Version: {{ trumpito_version.stdout }}
          5. Configuration: OK
          6. Aide fonctionnelle: OK
          7. Permissions: OK
          8. Modules Python: {{ python_files.stdout }} fichiers
          
          Version dÃ©ployÃ©e:
          {{ version_content.stdout }}
        dest: "{{ deploy_base }}/{{ target_color }}/SMOKE_TEST_RESULTS.txt"
    
    - name:  Tests terminÃ©s
      debug:
        msg: "Tous les tests de smoke ont rÃ©ussi. L'environnement {{ target_color }} peut recevoir du trafic."