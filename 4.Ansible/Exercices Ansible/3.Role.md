# Exercices sur les rôles

###     **Exercice 1 : Créer un rôle Ansible complet pour déployer une application Node.js avec systemd**

**Problématique** : Déployer une application Node.js dans `/opt/app`, gérer son service avec systemd via un rôle.

**Étapes** :

1. `ansible-galaxy init nodejs_app`

2. Ajouter :

   * `nodejs_app/tasks/main.yml` :

     ```yaml
     - name: Installer Node.js
       apt:
         name: nodejs
         state: present
       become: yes

     - name: Créer dossier application
       file:
         path: /opt/app
         state: directory
         owner: root
         mode: '0755'
       become: yes

     - name: Copier l'application
       copy:
         src: files/app.js
         dest: /opt/app/app.js
       become: yes

     - name: Déployer service systemd
       template:
         src: templates/nodeapp.service.j2
         dest: /etc/systemd/system/nodeapp.service
       notify: restart nodeapp
       become: yes
     ```
   * `nodejs_app/handlers/main.yml` :

     ```yaml
     - name: restart nodeapp
       systemd:
         name: nodeapp
         state: restarted
         enabled: yes
     ```
   * `nodejs_app/templates/nodeapp.service.j2` :

     ```
     [Unit]
     Description=Node.js App

     [Service]
     ExecStart=/usr/bin/node /opt/app/app.js
     Restart=always

     [Install]
     WantedBy=multi-user.target
     ```

3. **Playbook de test** :

   ```yaml
   - hosts: all
     roles:
       - nodejs_app
   ```

4. **Vérification** :

   ```bash
   curl http://localhost:3000
   ```

---

###     **Exercice 2 : Publier le rôle `nodejs_app` sur GitHub**

**Problématique** : Versionner et partager le rôle publiquement.

**Étapes** :

1. Créer un repo GitHub nommé `ansible-role-nodejs-app`
2. Ajouter une structure propre avec :

   * `README.md` (avec badges Galaxy + instructions)
   * `.github/workflows/ci.yml` pour Molecule
   * `.gitignore`
3. Initialiser Git :

   ```bash
   git init
   git remote add origin git@github.com:<votre_user>/ansible-role-nodejs-app.git
   git add .
   git commit -m "Initial commit"
   git push -u origin main
   ```

**Objectif atteint** : rôle Ansible versionné et prêt à être publié.

---

###     **Exercice 3 : Ajouter le rôle à Ansible Galaxy**

**Problématique** : Publier un rôle pour qu’il soit installable avec `ansible-galaxy install`.

**Étapes** :

1. Créer un compte sur [https://galaxy.ansible.com](https://galaxy.ansible.com)
2. Lier votre compte GitHub et importer le dépôt
3. Nom du rôle sur Galaxy : `github_user.nodejs_app`
4. Ajouter un tag git pour publier une version :

   ```bash
   git tag 1.0.0
   git push origin --tags
   ```

**Test d’installation** :

```bash
ansible-galaxy install github_user.nodejs_app
```

---

###     **Exercice 4 : Créer un rôle multi-OS avec détection Debian/RedHat**

**Problématique** : Installer `curl` avec une tâche différente selon la famille de distribution.

**Rôle `curl_installer/tasks/main.yml`** :

```yaml
- name: Installer curl sous Debian
  apt:
    name: curl
    state: present
  when: ansible_os_family == "Debian"
  become: yes

- name: Installer curl sous RedHat
  yum:
    name: curl
    state: present
  when: ansible_os_family == "RedHat"
  become: yes
```

**Test** :

```yaml
- hosts: all
  roles:
    - curl_installer
```

**Objectif atteint** : rôle multiplateforme fonctionnel.

---

###     **Exercice 5 : Tester un rôle avec Molecule et publier automatiquement avec GitHub Actions**

**Problématique** : Automatiser le test du rôle avec Molecule et la publication via CI/CD.

**Étapes** :

1. Ajouter Molecule :

   ```bash
   pip install molecule[docker]
   molecule init scenario -r nodejs_app -d docker
   ```

2. Modifier `molecule/default/molecule.yml` pour utiliser Ubuntu

3. Ajouter un scénario de test dans `molecule/default/verify.yml`

   ```yaml
   - name: Vérifier si service actif
     hosts: all
     tasks:
       - name: Vérifier nodeapp
         shell: systemctl is-active nodeapp
         register: result
         failed_when: result.stdout != "active"
   ```

4. Ajouter GitHub Actions `.github/workflows/ci.yml` :

```yaml
name: Molecule

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Installer dépendances
        run: |
          sudo apt update
          sudo apt install -y python3-pip docker.io
          pip3 install molecule[docker] yamllint ansible-lint
      - name: Tester avec Molecule
        run: molecule test
```

**Objectif atteint** : publication automatisée avec CI et validation du rôle avant déploiement.
